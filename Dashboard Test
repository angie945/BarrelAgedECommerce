from pathlib import Path
import csv
import re
from datetime import datetime, timedelta, date
from typing import Optional, List, Dict, Tuple

import pandas as pd
import streamlit as st

# -------------------------
# Page config
# -------------------------
st.set_page_config(page_title="Client Dashboard", layout="wide")

BASE_DIR = Path("/Users/angiemonserrate/Documents/BarrelEdge/Monday Reports/Amazon Reports/Weekly Uploads")
REPORT_EXTS = {".csv", ".xls", ".xlsx", ".xlsm"}

CLIENTS = [
    "AKT Products",
    "BISI",
    "DLP",
    "Edge Perfection",
    "GTX Performance",
    "Kul Mocks",
    "Meritool",
    "NP",
    "TapMed",
    "UTV",
    "Vico",
    "Eloquest",
    "Rooted",
]

APP_DIR = Path(__file__).parent
LOGO_PATH = APP_DIR / "logo.png"

# =========================
# Thresholds (Listing Metrics triggers - used for static HTML and app view)
# =========================
SALES_DROP_PCT_TRIGGER = 0.20      # 20% drop (Total Order Items)
TRAFFIC_DROP_PCT_TRIGGER = 0.20    # 20% drop (Page Views - Total)
BUYBOX_DROP_PTS_TRIGGER = 0.10     # 10 points drop (0.10 == 10%)
# =========================

_money_re = re.compile(r"\$?\s*([0-9,]+(?:\.[0-9]{1,2})?)")
_date_re = re.compile(r"(\d{4}-\d{2}-\d{2})")          # 2026-01-25
_date_re2 = re.compile(r"(\d{2}-\d{2}-\d{4})")         # 01-25-2026
_date_re3 = re.compile(r"(\d{1,2}/\d{1,2}/\d{2,4})")   # 1/25/2026 or 1/25/26


# =========================
# File helpers
# =========================

def latest_report_file(folder: Path):
    """Newest file by modified time (ignores Excel temp files)."""
    if not folder or not folder.exists():
        return None
    files = [
        f for f in folder.iterdir()
        if f.is_file()
        and f.suffix.lower() in REPORT_EXTS
        and not f.name.startswith("~$")
    ]
    return max(files, key=lambda f: f.stat().st_mtime) if files else None


def list_report_files(folder: Path) -> List[Path]:
    if not folder or not folder.exists():
        return []
    files = [
        f for f in folder.iterdir()
        if f.is_file()
        and f.suffix.lower() in REPORT_EXTS
        and not f.name.startswith("~$")
    ]
    return sorted(files, key=lambda f: f.stat().st_mtime)


def read_csv_rows(path: Path):
    rows = []
    with open(path, encoding="utf-8-sig", newline="") as f:
        for r in csv.reader(f):
            rows.append([c.strip() for c in r])
    return rows


def parse_currency_only(cell: str):
    if cell is None:
        return None
    s = str(cell).strip()
    if "$" not in s:
        return None
    m = _money_re.search(s.replace(" ", ""))
    if not m:
        return None
    return float(m.group(1).replace(",", ""))


def parse_date_from_any_text(text: str) -> Optional[date]:
    if not text:
        return None
    s = str(text)

    m = _date_re.search(s)
    if m:
        try:
            return datetime.strptime(m.group(1), "%Y-%m-%d").date()
        except:
            pass

    m = _date_re2.search(s)
    if m:
        try:
            return datetime.strptime(m.group(1), "%m-%d-%Y").date()
        except:
            pass

    m = _date_re3.search(s)
    if m:
        raw = m.group(1)
        parts = raw.split("/")
        if len(parts) == 3:
            mm, dd, yy = parts
            try:
                yy_i = int(yy)
                if yy_i < 100:
                    yy_i += 2000
                return date(int(yy_i), int(mm), int(dd))
            except:
                pass

    # try formats like 18-Jan or 18-Jan-2026
    try:
        dt = pd.to_datetime(s, errors="coerce")
        if pd.notna(dt):
            return dt.date()
    except:
        pass

    return None


def find_col(header_row, contains_text: str):
    target = contains_text.lower()
    for i, h in enumerate(header_row):
        if target in str(h).lower():
            return i
    return None


def fmt_currency(x):
    return f"${x:,.2f}" if x is not None else ""


def fmt_diff(x):
    if x is None:
        return ""
    return f"(${abs(x):,.2f})" if x < 0 else f"${x:,.2f}"


def diff_pct(cur, prev):
    """Fallback calculator only (used if report doesn't contain % change)."""
    if cur is None or prev is None:
        return None, ""
    diff = cur - prev
    if prev == 0:
        return diff, "#DIV/0!"
    return diff, f"{diff / prev:.0%}"


# =========================
# Percent styling (Streamlit)
# =========================

def _pct_to_float(val):
    if val is None:
        return None
    s = str(val).strip()
    if not s or s == "#DIV/0!":
        return None
    if s.endswith("%"):
        try:
            return float(s.replace("%", "").replace(",", "").strip()) / 100.0
        except:
            return None
    return None


def style_percent_columns(df: pd.DataFrame, cols):
    def colorize(v):
        p = _pct_to_float(v)
        if p is None:
            return ""
        if p < 0:
            return "color: #b91c1c; font-weight: 700;"
        if p > 0:
            return "color: #15803d; font-weight: 700;"
        return "color: #111827;"

    styler = df.style
    for c in cols:
        if c in df.columns:
            styler = styler.applymap(colorize, subset=[c])
    return styler


# =========================
# YTD/MTD extraction
# =========================

def _parse_pct_cell(raw):
    if raw is None:
        return ""
    s = str(raw).strip()
    if s == "" or s.lower() == "nan":
        return ""
    if s.endswith("%"):
        return s
    try:
        v = float(s.replace(",", ""))
        if -1 <= v <= 1:
            return f"{v:.0%}"
        if abs(v) <= 100:
            return f"{v:.2f}%"
    except:
        return ""
    return ""


def extract_compare_table_view_through(rows, period_kind: str):
    start = None
    for i, row in enumerate(rows):
        if "compare sales" in " ".join(row).lower() and "table view" in " ".join(row).lower():
            start = i
            break
    if start is None:
        return None, None, "", {"reason": "Could not find 'Compare Sales - Table view'"}

    header_i = None
    header = None
    for j in range(start, min(start + 250, len(rows))):
        cand = rows[j]
        txt = " | ".join(cand).lower()
        if "ordered product sales" in txt:
            header_i = j
            header = cand
            break

    if header is None:
        return None, None, "", {"reason": "Could not find Table view header row"}

    col_sales = None
    for idx, h in enumerate(header):
        if "ordered product sales" in str(h).lower():
            col_sales = idx
            break

    if col_sales is None:
        return None, None, "", {"reason": "Could not locate 'Ordered Product Sales' column"}

    if period_kind == "ytd":
        cur_key = "this year so far"
        prev_key = "last year through"
        pct_key = "% change from last year"
    else:
        cur_key = "this month so far"
        prev_key = "last month through"
        pct_key = "% change from last month"

    cur_row = prev_row = pct_row = None

    for k in range(header_i + 1, min(header_i + 250, len(rows))):
        r = rows[k]
        if not r:
            continue
        label = str(r[0]).strip().lower()

        if cur_row is None and label.startswith(cur_key):
            cur_row = r
        elif prev_row is None and label.startswith(prev_key):
            prev_row = r
        elif pct_row is None and label.startswith(pct_key):
            pct_row = r

        if cur_row is not None and prev_row is not None and pct_row is not None:
            break

    if cur_row is None or prev_row is None:
        return None, None, "", {"reason": "Missing required rows in Table view"}

    cur = parse_currency_only(cur_row[col_sales]) if col_sales < len(cur_row) else None
    prev = parse_currency_only(prev_row[col_sales]) if col_sales < len(prev_row) else None
    pct_str = ""
    if pct_row is not None and col_sales < len(pct_row):
        pct_str = _parse_pct_cell(pct_row[col_sales])

    return cur, prev, pct_str, {"reason": "Extracted from Table view (through rows)"}


def extract_compare_graph_view_money(rows, this_col_options, last_col_options):
    start = None
    for i, row in enumerate(rows):
        joined = " ".join(row).lower()
        if "compare sales" in joined and "graph view" in joined:
            start = i
            break
    if start is None:
        return None, None, {"reason": "Could not find 'Compare Sales - Graph view' section"}

    header_i = None
    header_row = None
    col_this = None
    col_last = None

    for j in range(start, min(start + 250, len(rows))):
        candidate = rows[j]
        cand_text = " | ".join(candidate).lower()

        for a in this_col_options:
            if a.lower() in cand_text:
                tmp_this = find_col(candidate, a)
                if tmp_this is None:
                    continue
                for b in last_col_options:
                    if b.lower() in cand_text:
                        tmp_last = find_col(candidate, b)
                        if tmp_last is None:
                            continue
                        header_i = j
                        header_row = candidate
                        col_this = tmp_this
                        col_last = tmp_last
                        break
            if header_row is not None:
                break
        if header_row is not None:
            break

    if header_row is None:
        return None, None, {"reason": "Could not find header row with expected columns"}

    data_row = None
    for k in range(header_i + 1, min(header_i + 200, len(rows))):
        r = rows[k]
        v1 = r[col_this] if col_this < len(r) else ""
        v2 = r[col_last] if col_last < len(r) else ""
        if "$" in str(v1) or "$" in str(v2):
            data_row = r
            break

    if data_row is None:
        return None, None, {"reason": "Found header row but no data row with $ values"}

    cur = parse_currency_only(data_row[col_this]) if col_this < len(data_row) else None
    prev = parse_currency_only(data_row[col_last]) if col_last < len(data_row) else None
    return cur, prev, {"reason": "Graph view money"}


def get_ytd_for_client(client: str):
    folder = BASE_DIR / client / "Year"
    fp = latest_report_file(folder)
    if not fp:
        return None, None, "", {"reason": "No Year file found", "file": None}

    rows = read_csv_rows(fp)

    cur, prev, pct_str, dbg = extract_compare_table_view_through(rows, period_kind="ytd")
    if cur is not None and prev is not None:
        return cur, prev, pct_str, {"file": str(fp), "source": "table_view_through", **dbg}

    YTD_THIS = ["This year so far (Ordered product sales)", "This year so far", "This year"]
    YTD_LAST = ["Last year (Ordered product sales)", "Last year"]
    cur2, prev2, dbg2 = extract_compare_graph_view_money(rows, YTD_THIS, YTD_LAST)
    return cur2, prev2, "", {"file": str(fp), "source": "graph_view_money", **dbg2}


def get_mtd_for_client(client: str):
    folder = BASE_DIR / client / "Month"
    fp = latest_report_file(folder)
    if not fp:
        return None, None, "", {"reason": "No Month file found", "file": None}

    rows = read_csv_rows(fp)

    cur, prev, pct_str, dbg = extract_compare_table_view_through(rows, period_kind="mtd")
    if cur is not None and prev is not None:
        return cur, prev, pct_str, {"file": str(fp), "source": "table_view_through", **dbg}

    MTD_THIS = ["This month so far (Ordered product sales)", "This month so far", "This month"]
    MTD_LAST = ["Last month (Ordered product sales)", "Last month"]
    cur2, prev2, dbg2 = extract_compare_graph_view_money(rows, MTD_THIS, MTD_LAST)
    return cur2, prev2, "", {"file": str(fp), "source": "graph_view_money", **dbg2}


# =========================
# WTD (last 6 weeks)
# =========================

def week_ending_sunday(d):
    days_to_sun = 6 - d.weekday()
    return d + pd.Timedelta(days=days_to_sun)


def extract_daily_sales_timeseries(rows):
    start = None
    for i, row in enumerate(rows):
        joined = " ".join(row).lower()
        if "compare sales" in joined and "graph view" in joined:
            start = i
            break
    if start is None:
        return None, {"reason": "Could not find 'Compare Sales - Graph view'"}

    header_i = None
    header = None
    col_time = col_this = col_last = None

    for j in range(start, min(start + 200, len(rows))):
        cand = rows[j]
        txt = " | ".join(cand).lower()
        if "time" in txt and "selected date range" in txt and "same date range" in txt:
            header_i = j
            header = cand
            col_time = find_col(header, "time")

            for idx, h in enumerate(header):
                hlow = str(h).lower()
                if "selected date range" in hlow and "ordered product sales" in hlow:
                    col_this = idx
                if "same date range one year ago" in hlow and "ordered product sales" in hlow:
                    col_last = idx

            if col_time is not None and col_this is not None and col_last is not None:
                break

    if header is None or col_time is None or col_this is None or col_last is None:
        return None, {"reason": "Could not find daily header row for Week report"}

    out = []
    for k in range(header_i + 1, min(header_i + 6000, len(rows))):
        r = rows[k]
        if not r or len(r) <= col_time:
            continue

        d = parse_date_from_any_text(r[col_time])
        if d is None:
            continue

        v_this = r[col_this] if col_this < len(r) else ""
        v_last = r[col_last] if col_last < len(r) else ""

        sales_this = parse_currency_only(v_this)
        sales_last = parse_currency_only(v_last)

        if sales_this is None and sales_last is None:
            continue

        out.append({"date": d, "sales_this": sales_this or 0.0, "sales_last": sales_last or 0.0})

    if not out:
        return None, {"reason": "No daily rows with sales values"}

    df = pd.DataFrame(out)
    return df, {"rows_extracted": len(df)}


def get_wtd_last_6_weeks_for_client(client: str, n_weeks=6):
    folder = BASE_DIR / client / "Week"
    fp = latest_report_file(folder)
    if not fp:
        return pd.DataFrame(columns=["Week of", "WTD 2026", "WTD 2025", "Year over Year"]), {"reason": "No Week file found", "file": None}

    rows = read_csv_rows(fp)
    daily_df, dbg = extract_daily_sales_timeseries(rows)
    if daily_df is None or daily_df.empty:
        return pd.DataFrame(columns=["Week of", "WTD 2026", "WTD 2025", "Year over Year"]), {"file": str(fp), **dbg}

    daily_df["date"] = pd.to_datetime(daily_df["date"])
    daily_df["week_of"] = daily_df["date"].apply(week_ending_sunday)

    weekly = (
        daily_df
        .groupby("week_of", as_index=False)[["sales_this", "sales_last"]]
        .sum()
        .sort_values("week_of", ascending=False)
        .head(n_weeks)
    )

    out = []
    for _, r in weekly.iterrows():
        this_val = float(r["sales_this"])
        last_val = float(r["sales_last"])
        yoy = ""
        if last_val != 0:
            yoy = f"{((this_val - last_val) / last_val):.0%}"

        out.append({
            "Week of": pd.to_datetime(r["week_of"]).strftime("%d-%b"),
            "WTD 2026": fmt_currency(this_val),
            "WTD 2025": fmt_currency(last_val),
            "Year over Year": yoy,
        })

    return pd.DataFrame(out), {"file": str(fp), **dbg}


# =========================
# Detail Sales & Traffic (Excel) - weekly per ASIN
# =========================

def _clean_col(c: str) -> str:
    return re.sub(r"\s+", " ", str(c).strip())


def _to_percent_0to1(x):
    if x is None or (isinstance(x, float) and pd.isna(x)):
        return None
    s = str(x).strip()
    if s == "" or s.lower() == "nan":
        return None
    try:
        if s.endswith("%"):
            return float(s.replace("%", "").strip()) / 100.0
        v = float(s.replace(",", ""))
        if 0 <= v <= 1:
            return v
        if 1 < v <= 100:
            return v / 100.0
        return None
    except:
        return None


def _to_money(x):
    if x is None or (isinstance(x, float) and pd.isna(x)):
        return 0.0
    s = str(x).strip()
    if s == "" or s.lower() == "nan":
        return 0.0
    if "$" in s:
        v = parse_currency_only(s)
        return float(v or 0.0)
    try:
        return float(s.replace(",", ""))
    except:
        return 0.0


def _to_int(x):
    if x is None or (isinstance(x, float) and pd.isna(x)):
        return 0
    s = str(x).strip()
    if s == "" or s.lower() == "nan":
        return 0
    try:
        return int(float(s.replace(",", "")))
    except:
        return 0


def pick_detail_folder(client_folder: Path):
    if not client_folder.exists():
        return None, {"reason": "Client folder does not exist"}

    for p in client_folder.iterdir():
        if p.is_dir():
            nm = p.name.lower()
            if "detail" in nm and "traffic" in nm:
                return p, {"reason": "Found detail/traffic folder"}

    return None, {"reason": "No matching detail/traffic folder found"}


def pick_detail_file(folder: Path):
    if not folder or not folder.exists():
        return None, {"reason": "Folder does not exist"}

    files = [
        f for f in folder.iterdir()
        if f.is_file()
        and f.suffix.lower() in REPORT_EXTS
        and not f.name.startswith("~$")
    ]

    preferred = [f for f in files if ("detail" in f.name.lower() and "traffic" in f.name.lower())]
    if preferred:
        return max(preferred, key=lambda f: f.stat().st_mtime), {"reason": "Picked preferred detail/traffic file"}

    if files:
        return max(files, key=lambda f: f.stat().st_mtime), {"reason": "Picked newest file"}

    return None, {"reason": "No report files found in folder"}


def get_detail_sales_traffic_weekly_for_client(client: str, n_weeks=6):
    client_folder = BASE_DIR / client
    detail_folder, _ = pick_detail_folder(client_folder)
    if not detail_folder:
        return pd.DataFrame(), {}

    fp, _ = pick_detail_file(detail_folder)
    if not fp:
        return pd.DataFrame(), {}

    try:
        df = pd.read_excel(fp, sheet_name=0, header=0)
    except Exception:
        return pd.DataFrame(), {}

    if df is None or df.empty:
        return pd.DataFrame(), {}

    df.columns = [_clean_col(c) for c in df.columns]

    col_date = "Date" if "Date" in df.columns else None
    col_asin = "(Parent) ASIN" if "(Parent) ASIN" in df.columns else ("ASIN" if "ASIN" in df.columns else None)

    def find_first(substrings):
        for c in df.columns:
            cl = c.lower()
            if any(s in cl for s in substrings):
                return c
        return None

    col_sessions = find_first(["sessions"])
    col_pageviews = find_first(["page views", "pageviews"])
    col_feat = find_first(["featured offer", "buy box"])
    col_units = find_first(["units ordered", "units"])
    col_sales = find_first(["ordered product sales", "product sales", "sales"])
    col_order_items = find_first(["total order items", "order items"])

    required = [col_date, col_asin, col_sessions, col_pageviews, col_units, col_sales, col_order_items]
    if any(x is None for x in required):
        return pd.DataFrame(), {}

    out = pd.DataFrame()
    out["date"] = pd.to_datetime(df[col_date], errors="coerce")
    out["asin"] = df[col_asin].astype(str).str.strip().str.upper()
    out = out.dropna(subset=["date"])
    out = out[out["asin"] != ""]
    out = out[out["asin"].str.match(r"^[A-Z0-9]{8,14}$", na=False)]

    out["sessions"] = df.loc[out.index, col_sessions].apply(_to_int)
    out["pageviews"] = df.loc[out.index, col_pageviews].apply(_to_int)
    out["units"] = df.loc[out.index, col_units].apply(_to_int)
    out["sales"] = df.loc[out.index, col_sales].apply(_to_money)
    out["total_order_items"] = df.loc[out.index, col_order_items].apply(_to_int)

    if col_feat is not None:
        out["featured_offer_pct"] = df.loc[out.index, col_feat].apply(_to_percent_0to1)
    else:
        out["featured_offer_pct"] = None

    out["week_ending"] = pd.to_datetime(out["date"].dt.date).apply(lambda d: week_ending_sunday(d))

    feat = pd.to_numeric(out["featured_offer_pct"], errors="coerce")
    pv = out["pageviews"].astype(float)
    out["feat_x_pv"] = feat.fillna(0.0) * pv
    out["pv_for_feat"] = pv.where(feat.notna(), 0.0)

    weekly = (
        out.groupby(["asin", "week_ending"], as_index=False)
        .agg(
            sessions=("sessions", "sum"),
            pageviews=("pageviews", "sum"),
            units=("units", "sum"),
            sales=("sales", "sum"),
            total_order_items=("total_order_items", "sum"),
            feat_x_pv=("feat_x_pv", "sum"),
            pv_for_feat=("pv_for_feat", "sum"),
        )
    )

    weekly["featured_offer_pct"] = weekly.apply(
        lambda r: (r["feat_x_pv"] / r["pv_for_feat"]) if r["pv_for_feat"] and r["pv_for_feat"] > 0 else 0.0,
        axis=1
    )
    weekly["unit_session_pct"] = weekly.apply(
        lambda r: (r["units"] / r["sessions"]) if r["sessions"] else 0.0,
        axis=1
    )

    weekly = weekly.sort_values(["asin", "week_ending"], ascending=[True, False])
    weekly = weekly.groupby("asin", as_index=False).head(n_weeks).reset_index(drop=True)

    display = weekly.copy()
    display["Date"] = pd.to_datetime(display["week_ending"]).dt.strftime("%d-%b")
    display["Session Total"] = display["sessions"].astype(int)
    display["Page Views Total"] = display["pageviews"].astype(int)
    display["Featured Offer Percentage"] = (display["featured_offer_pct"] * 100).round(0).astype(int).astype(str) + "%"
    display["Units Ordered"] = display["units"].astype(int)
    display["Unit Session Percentage"] = (display["unit_session_pct"] * 100).round(0).astype(int).astype(str) + "%"
    display["Ordered Product Sales"] = display["sales"].apply(fmt_currency)
    display["Total Order Items"] = display["total_order_items"].astype(int)

    display = display[[
        "asin", "Date", "Session Total", "Page Views Total",
        "Featured Offer Percentage", "Units Ordered", "Unit Session Percentage",
        "Ordered Product Sales", "Total Order Items"
    ]].rename(columns={"asin": "ASIN"})

    return display, {}


# =========================
# Listing Metrics (static snapshot logic)
# =========================

def _find_detail_folder(client_folder: Path):
    if not client_folder.exists():
        return None
    for p in client_folder.iterdir():
        if p.is_dir():
            nm = p.name.lower()
            if "detail" in nm and "traffic" in nm:
                return p
    return None


def _pick_detail_file(folder: Path):
    return latest_report_file(folder)


def _read_detail_sales_traffic_raw(client: str) -> pd.DataFrame:
    client_folder = BASE_DIR / client
    detail_folder = _find_detail_folder(client_folder)
    if not detail_folder:
        return pd.DataFrame()

    fp = _pick_detail_file(detail_folder)
    if not fp:
        return pd.DataFrame()

    try:
        df = pd.read_excel(fp, sheet_name=0, header=0)
    except Exception:
        return pd.DataFrame()

    if df is None or df.empty:
        return pd.DataFrame()

    df.columns = [_clean_col(c) for c in df.columns]
    return df


def get_detail_metrics_daily(client: str) -> pd.DataFrame:
    df = _read_detail_sales_traffic_raw(client)
    if df.empty:
        return pd.DataFrame()

    col_date = "Date" if "Date" in df.columns else None
    col_asin = "(Parent) ASIN" if "(Parent) ASIN" in df.columns else ("ASIN" if "ASIN" in df.columns else None)

    def find_first(substrings):
        for c in df.columns:
            cl = c.lower()
            if any(s in cl for s in substrings):
                return c
        return None

    col_pageviews = find_first(["page views - total", "page views total", "pageviews - total", "page views", "pageviews"])
    col_order_items = find_first(["total order items", "order items"])
    col_feat = find_first(["featured offer", "buy box"])

    if not (col_date and col_asin and col_pageviews and col_order_items):
        return pd.DataFrame()

    out = pd.DataFrame()
    out["date"] = pd.to_datetime(df[col_date], errors="coerce")
    out["asin"] = df[col_asin].astype(str).str.strip().str.upper()
    out = out.dropna(subset=["date"])
    out = out[out["asin"].str.match(r"^[A-Z0-9]{8,14}$", na=False)]

    out["total_order_items"] = df.loc[out.index, col_order_items].apply(_to_int)
    out["pageviews_total"] = df.loc[out.index, col_pageviews].apply(_to_int)

    if col_feat is not None:
        out["featured_offer_pct"] = df.loc[out.index, col_feat].apply(_to_percent_0to1)
    else:
        out["featured_offer_pct"] = None

    return out


def compute_listing_metric_triggers_all_clients() -> Tuple[pd.DataFrame, pd.DataFrame]:
    today = datetime.now().date()
    end_cur = today
    start_cur = today - timedelta(days=6)
    end_prev = start_cur - timedelta(days=1)
    start_prev = end_prev - timedelta(days=6)

    detail_rows = []

    for client in CLIENTS:
        daily = get_detail_metrics_daily(client)
        if daily.empty:
            continue

        daily["date"] = pd.to_datetime(daily["date"]).dt.date

        cur = daily[(daily["date"] >= start_cur) & (daily["date"] <= end_cur)]
        prev = daily[(daily["date"] >= start_prev) & (daily["date"] <= end_prev)]

        if cur.empty or prev.empty:
            continue

        cur_agg = cur.groupby("asin", as_index=False).agg(
            cur_sales=("total_order_items", "sum"),
            cur_traffic=("pageviews_total", "sum"),
            cur_bb=("featured_offer_pct", "mean"),
        )
        prev_agg = prev.groupby("asin", as_index=False).agg(
            prev_sales=("total_order_items", "sum"),
            prev_traffic=("pageviews_total", "sum"),
            prev_bb=("featured_offer_pct", "mean"),
        )

        merged = cur_agg.merge(prev_agg, on="asin", how="inner")

        def pct_drop(cur_v, prev_v):
            if prev_v is None or prev_v == 0:
                return None
            return (prev_v - cur_v) / prev_v

        for _, r in merged.iterrows():
            asin = r["asin"]

            sd = pct_drop(r["cur_sales"], r["prev_sales"])
            td = pct_drop(r["cur_traffic"], r["prev_traffic"])
            bb_drop = None
            if pd.notna(r["cur_bb"]) and pd.notna(r["prev_bb"]):
                bb_drop = float(r["prev_bb"] - r["cur_bb"])

            if sd is not None and sd >= SALES_DROP_PCT_TRIGGER:
                detail_rows.append({
                    "Client": client,
                    "ASIN": asin,
                    "Type of Trigger": "Sale drop",
                    "Current": int(r["cur_sales"]),
                    "Previous": int(r["prev_sales"]),
                    "Delta": f"-{sd:.0%}",
                })
            if td is not None and td >= TRAFFIC_DROP_PCT_TRIGGER:
                detail_rows.append({
                    "Client": client,
                    "ASIN": asin,
                    "Type of Trigger": "Traffic drop",
                    "Current": int(r["cur_traffic"]),
                    "Previous": int(r["prev_traffic"]),
                    "Delta": f"-{td:.0%}",
                })
            if bb_drop is not None and bb_drop >= BUYBOX_DROP_PTS_TRIGGER:
                detail_rows.append({
                    "Client": client,
                    "ASIN": asin,
                    "Type of Trigger": "Buy box drop",
                    "Current": f"{(r['cur_bb'] or 0)*100:.0f}%",
                    "Previous": f"{(r['prev_bb'] or 0)*100:.0f}%",
                    "Delta": f"-{bb_drop*100:.0f} pts",
                })

    detail_df = pd.DataFrame(detail_rows)
    if detail_df.empty:
        summary_df = pd.DataFrame(columns=["Client", "# of triggers", "Type of triggers"])
        return summary_df, detail_df

    grp = detail_df.groupby("Client")["Type of Trigger"].agg(list).reset_index()
    grp["# of triggers"] = grp["Type of Trigger"].apply(len)
    grp["Type of triggers"] = grp["Type of Trigger"].apply(lambda xs: ", ".join(sorted(set(xs))))
    summary_df = grp[["Client", "# of triggers", "Type of triggers"]].sort_values("# of triggers", ascending=False)

    return summary_df, detail_df


# =========================
# Seller Health (reads weekly table like screenshot)
# =========================

def _find_subfolder_by_keywords(client_folder: Path, keywords: List[str]) -> Optional[Path]:
    if not client_folder.exists():
        return None
    kws = [k.lower() for k in keywords]

    # strict match first
    for p in client_folder.iterdir():
        if p.is_dir():
            nm = p.name.lower()
            if all(k in nm for k in kws):
                return p

    # fallback partial
    for p in client_folder.iterdir():
        if p.is_dir():
            nm = p.name.lower()
            if any(k in nm for k in kws):
                return p

    return None


def get_seller_health_history_for_client(client: str) -> pd.DataFrame:
    """
    Reads weekly Seller Health tables like:
    Client | Week of | Account Health | Suppressed listings | Seller Feedback
    """
    client_folder = BASE_DIR / client

    # Folder should be named like "Seller Health" (or contains seller+health)
    folder = _find_subfolder_by_keywords(client_folder, ["seller", "health"])
    if not folder:
        return pd.DataFrame(columns=["Date", "Account Health", "Suppressed listings", "Seller Feedback"])

    files = list_report_files(folder)
    rows = []

    for fp in files:
        try:
            if fp.suffix.lower() == ".csv":
                df = pd.read_csv(fp, encoding="utf-8-sig")
            else:
                df = pd.read_excel(fp, sheet_name=0)
        except Exception:
            continue

        if df.empty:
            continue

        df.columns = [_clean_col(c) for c in df.columns]

        # find required columns (case-insensitive)
        col_client = None
        col_week = None
        col_ah = None
        col_sup = None
        col_fb = None

        for ccol in df.columns:
            cl = str(ccol).lower()
            if cl == "client":
                col_client = ccol
            elif "week" in cl:
                col_week = ccol
            elif "account health" in cl:
                col_ah = ccol
            elif "suppressed" in cl:
                col_sup = ccol
            elif "feedback" in cl:
                col_fb = ccol

        if any(x is None for x in [col_client, col_week, col_ah, col_sup, col_fb]):
            continue

        sub = df[df[col_client].astype(str).str.strip().str.upper() == client.strip().upper()]
        if sub.empty:
            continue

        for _, r in sub.iterrows():
            wk_raw = str(r[col_week]).strip()
            wk_date = parse_date_from_any_text(wk_raw)
            if wk_date is None:
                try:
                    wk_date = pd.to_datetime(wk_raw, errors="coerce").date()
                except:
                    continue

            def _safe_int(v):
                try:
                    if pd.isna(v):
                        return 0
                    return int(float(str(v).replace(",", "").strip()))
                except:
                    return 0

            rows.append({
                "Date": wk_date,
                "Account Health": _safe_int(r[col_ah]),
                "Suppressed listings": _safe_int(r[col_sup]),
                "Seller Feedback": _safe_int(r[col_fb]),
            })

    if not rows:
        return pd.DataFrame(columns=["Date", "Account Health", "Suppressed listings", "Seller Feedback"])

    out = pd.DataFrame(rows)
    out["Date"] = pd.to_datetime(out["Date"]).dt.strftime("%Y-%m-%d")
    out = out.sort_values("Date", ascending=False).drop_duplicates(subset=["Date"]).reset_index(drop=True)
    return out


# =========================
# Static HTML helpers (+ color %)
# =========================

def _html_escape(s):
    return (
        str(s)
        .replace("&", "&amp;")
        .replace("<", "&lt;")
        .replace(">", "&gt;")
        .replace('"', "&quot;")
        .replace("'", "&#039;")
    )


def _parse_pct_for_html(val: str) -> Optional[float]:
    return _pct_to_float(val)


def _html_cell_with_pct_color(val: object) -> str:
    s = "" if val is None else str(val)
    p = _parse_pct_for_html(s)
    if p is None:
        return _html_escape(s)
    if p < 0:
        return f"<span class='neg'>{_html_escape(s)}</span>"
    if p > 0:
        return f"<span class='pos'>{_html_escape(s)}</span>"
    return _html_escape(s)


def _df_to_html_table(df: pd.DataFrame) -> str:
    if df is None or df.empty:
        return "<p class='muted'>No data.</p>"

    cols = df.columns.tolist()
    cols_html = [_html_escape(c) for c in cols]

    pct_cols = set()
    for c in cols:
        cl = str(c).lower()
        if "diff %" in cl or "difference %" in cl or "year over year" in cl:
            pct_cols.add(c)

    rows_html = []
    for _, r in df.iterrows():
        tds = []
        for c in cols:
            v = r[c]
            if c in pct_cols:
                tds.append(f"<td>{_html_cell_with_pct_color(v)}</td>")
            else:
                tds.append(f"<td>{_html_escape(v)}</td>")
        rows_html.append("<tr>" + "".join(tds) + "</tr>")

    thead = "<tr>" + "".join(f"<th>{c}</th>" for c in cols_html) + "</tr>"
    tbody = "\n".join(rows_html)

    return f"""
    <table class="tbl">
      <thead>{thead}</thead>
      <tbody>{tbody}</tbody>
    </table>
    """


# =========================
# Static Clickable HTML Dashboard (NO filters) - FULL
# =========================

def build_static_clickable_dashboard_html_full() -> str:
    # -------- Client Summary (YTD/MTD + weekly breakdown)
    ytd_rows = []
    for c in CLIENTS:
        cur, prev, pct_from_report, _ = get_ytd_for_client(c)
        diff, fallback_pct = diff_pct(cur, prev)
        ytd_rows.append({
            "Client": c,
            "This year so far": fmt_currency(cur),
            "Last year": fmt_currency(prev),
            "Difference": fmt_diff(diff),
            "Difference %": pct_from_report if pct_from_report else fallback_pct,
        })
    ytd_df = pd.DataFrame(ytd_rows)

    mtd_rows = []
    for c in CLIENTS:
        cur, prev, pct_from_report, _ = get_mtd_for_client(c)
        diff, fallback_pct = diff_pct(cur, prev)
        mtd_rows.append({
            "Client": c,
            "This month so far": fmt_currency(cur),
            "Last month": fmt_currency(prev),
            "Difference": fmt_diff(diff),
            "Difference %": pct_from_report if pct_from_report else fallback_pct,
        })
    mtd_df = pd.DataFrame(mtd_rows)

    weekly_blocks = []
    for c in CLIENTS:
        wtd_df, _ = get_wtd_last_6_weeks_for_client(c, n_weeks=6)
        weekly_blocks.append(f"""
          <div class="card">
            <h3>{_html_escape(c)}</h3>
            <h4>Last 6 Weeks (WTD)</h4>
            {_df_to_html_table(wtd_df) if not wtd_df.empty else "<p class='muted'>No Week report found yet.</p>"}
          </div>
        """)

    summary_view = f"""
      <div class="card">
        <h2>Client Summary</h2>
        <h3>YEAR TO DATE (Ordered Product Sales)</h3>
        {_df_to_html_table(ytd_df)}
        <h3>MONTH TO DATE (Ordered Product Sales)</h3>
        {_df_to_html_table(mtd_df)}
      </div>

      <h2>Weekly Breakdown (Last 6 Weeks)</h2>
      {''.join(weekly_blocks)}
    """

    # -------- Client Pages (all clients) INCLUDING full per-ASIN tables
    client_pages_blocks = []
    for c in CLIENTS:
        cur, prev, pct_from_report, _ = get_ytd_for_client(c)
        diff, fallback_pct = diff_pct(cur, prev)
        ytd_small = pd.DataFrame([{
            "This year so far": fmt_currency(cur),
            "Last year": fmt_currency(prev),
            "Difference": fmt_diff(diff),
            "Diff %": pct_from_report if pct_from_report else fallback_pct,
        }])

        cur, prev, pct_from_report, _ = get_mtd_for_client(c)
        diff, fallback_pct = diff_pct(cur, prev)
        mtd_small = pd.DataFrame([{
            "This month so far": fmt_currency(cur),
            "Last month": fmt_currency(prev),
            "Difference": fmt_diff(diff),
            "Diff %": pct_from_report if pct_from_report else fallback_pct,
        }])

        wtd_df, _ = get_wtd_last_6_weeks_for_client(c, n_weeks=6)
        wtd_html = "<p class='muted'>No Week report found yet.</p>" if wtd_df.empty else _df_to_html_table(wtd_df)

        detail_df, _ = get_detail_sales_traffic_weekly_for_client(c, n_weeks=6)
        if detail_df.empty:
            detail_html = "<p class='muted'>No Detail Sales &amp; Traffic.</p>"
        else:
            parts = []
            for asin in detail_df["ASIN"].dropna().unique().tolist():
                asin_tbl = detail_df[detail_df["ASIN"] == asin].drop(columns=["ASIN"]).reset_index(drop=True)
                parts.append(f"<h4>ASIN: {_html_escape(asin)}</h4>{_df_to_html_table(asin_tbl)}")
            detail_html = "".join(parts)

        client_pages_blocks.append(f"""
          <div class="card">
            <h2>Client Page: {_html_escape(c)}</h2>

            <div class="two-col">
              <div>
                <h3>YTD</h3>
                {_df_to_html_table(ytd_small)}
              </div>
              <div>
                <h3>MTD</h3>
                {_df_to_html_table(mtd_small)}
              </div>
            </div>

            <h3>WTD (Last 6 Weeks)</h3>
            {wtd_html}

            <h3>Detail Sales &amp; Traffic (Per ASIN)</h3>
            {detail_html}
          </div>
        """)

    pages_view = f"""
      <h2>Client Pages (All Clients)</h2>
      {''.join(client_pages_blocks)}
    """

    # -------- Listing Metrics
    lm_summary_df, lm_detail_df = compute_listing_metric_triggers_all_clients()
    if not lm_detail_df.empty:
        lm_detail_df = lm_detail_df.sort_values(["Client", "Type of Trigger", "ASIN"]).reset_index(drop=True)

    listing_view = f"""
      <div class="card">
        <h2>Listing Metrics Tracker (Static Snapshot)</h2>
        <p class="muted">
          Trigger logic: compares last 7 days vs previous 7 days.
          Sales: Total Order Items, Traffic: Page Views - Total, Buy Box: Featured Offer %.
        </p>
        <h3>Summary (by Client)</h3>
        {_df_to_html_table(lm_summary_df)}
        <h3>Triggered ASINs (All Clients)</h3>
        {_df_to_html_table(lm_detail_df)}
      </div>
    """

    # -------- Seller Health (HISTORY tables per client)
    seller_blocks = []
    for c in CLIENTS:
        hist = get_seller_health_history_for_client(c)
        seller_blocks.append(f"""
          <div class="card">
            <h2>{_html_escape(c)}</h2>
            {_df_to_html_table(hist)}
          </div>
        """)

    seller_view = f"""
      <h2>Seller Health</h2>
      <p class="muted">History view. Data comes directly from the weekly Seller Health tables (like your screenshot).</p>
      {''.join(seller_blocks)}
    """

    logo_html = ""
    if LOGO_PATH.exists():
        logo_html = f"<img class='logo' src='{_html_escape(str(LOGO_PATH))}' />"

    html = f"""
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Static Client Dashboard</title>
  <style>
    * {{
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }}

    body {{
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }}

    .topbar {{
      position: sticky;
      top: 0;
      background: #111827;
      color: #fff;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 999;
    }}

    .topbar .title {{
      font-weight: 800;
      font-size: 14px;
      letter-spacing: .2px;
    }}

    .nav a {{
      color: #fff;
      text-decoration: none;
      margin-left: 14px;
      font-weight: 700;
      font-size: 12px;
      opacity: .9;
    }}
    .nav a.active {{
      text-decoration: underline;
      opacity: 1;
    }}

    .wrap {{
      padding: 16px 18px 28px 18px;
      max-width: 1250px;
      margin: 0 auto;
    }}

    .logo {{
      width: 170px;
      display: block;
      margin: 8px auto 12px auto;
    }}

    .meta {{
      font-size: 12px;
      color: #374151;
      margin-bottom: 10px;
      text-align: center;
    }}

    .view {{
      display: none;
    }}
    .view.active {{
      display: block;
    }}

    .card {{
      background: #ffffff;
      border-radius: 12px;
      padding: 14px 14px;
      margin: 12px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }}

    .two-col {{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }}

    h2 {{
      margin: 14px 0 8px 0;
      font-size: 18px;
    }}
    h3 {{
      margin: 14px 0 8px 0;
      font-size: 14px;
    }}
    h4 {{
      margin: 12px 0 6px 0;
      font-size: 12px;
    }}

    .muted {{
      color: #6b7280;
      font-size: 12px;
    }}

    .pos {{
      color: #15803d;
      font-weight: 800;
    }}
    .neg {{
      color: #b91c1c;
      font-weight: 800;
    }}

    .tbl {{
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin: 8px 0 14px 0;
    }}
    .tbl th {{
      background: #111827;
      color: #fff;
      text-align: left;
      padding: 8px;
      font-weight: 700;
      border: 1px solid #e5e7eb;
    }}
    .tbl td {{
      padding: 7px 8px;
      border: 1px solid #e5e7eb;
      vertical-align: top;
    }}
    .tbl tr:nth-child(even) td {{
      background: #f9fafb;
    }}

    @media print {{
      body {{ background: #fff; }}
      .topbar {{ position: static; }}
      .wrap {{ max-width: none; }}
      .card {{ box-shadow: none; border: 1px solid #e5e7eb; }}
    }}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="title">Static Client Dashboard (No Filters)</div>
    <div class="nav">
      <a href="#summary" id="nav-summary" onclick="showView('summary'); return false;">Client Summary</a>
      <a href="#pages" id="nav-pages" onclick="showView('pages'); return false;">Client Pages</a>
      <a href="#listing" id="nav-listing" onclick="showView('listing'); return false;">Listing Metrics</a>
      <a href="#seller" id="nav-seller" onclick="showView('seller'); return false;">Seller Health</a>
    </div>
  </div>

  <div class="wrap">
    {logo_html}
    <div class="meta">Generated: {_html_escape(datetime.now().strftime("%Y-%m-%d %H:%M"))}</div>

    <div id="view-summary" class="view active">{summary_view}</div>
    <div id="view-pages" class="view">{pages_view}</div>
    <div id="view-listing" class="view">{listing_view}</div>
    <div id="view-seller" class="view">{seller_view}</div>
  </div>

<script>
  function clearNav() {{
    document.getElementById('nav-summary').classList.remove('active');
    document.getElementById('nav-pages').classList.remove('active');
    document.getElementById('nav-listing').classList.remove('active');
    document.getElementById('nav-seller').classList.remove('active');
  }}

  function showView(which) {{
    document.getElementById('view-summary').classList.remove('active');
    document.getElementById('view-pages').classList.remove('active');
    document.getElementById('view-listing').classList.remove('active');
    document.getElementById('view-seller').classList.remove('active');

    document.getElementById('view-' + which).classList.add('active');

    clearNav();
    document.getElementById('nav-' + which).classList.add('active');
    window.location.hash = '#' + which;
  }}

  (function() {{
    var h = (window.location.hash || '').replace('#','');
    if (h === 'pages') showView('pages');
    else if (h === 'listing') showView('listing');
    else if (h === 'seller') showView('seller');
    else showView('summary');
  }})();
</script>

</body>
</html>
    """.strip()

    return html


# =========================
# Streamlit Navigation (interactive view)
# =========================
st.sidebar.header("Navigation")
page = st.sidebar.radio(
    "Go to",
    ["Client Summary", "Client Pages", "Listing Metrics Tracker", "Seller Health"],
    index=0
)

selected_client = None
if page == "Client Pages":
    selected_client = st.sidebar.selectbox("Select a client", CLIENTS)

# =========================
# Export: Static clickable HTML (NO filters)
# =========================
st.sidebar.divider()
st.sidebar.subheader("Export")
static_full_html = build_static_clickable_dashboard_html_full()
st.sidebar.download_button(
    label="üåê Download: Static HTML Dashboard (Clickable, No Filters)",
    data=static_full_html.encode("utf-8"),
    file_name=f"static_dashboard_full_{datetime.now().strftime('%Y%m%d_%H%M')}.html",
    mime="text/html",
    use_container_width=True,
)


# =========================
# Streamlit Pages
# =========================

def render_client_summary():
    if LOGO_PATH.exists():
        left, mid, right = st.columns([2, 1, 2])
        with mid:
            st.image(str(LOGO_PATH), width=180)
        st.write("")

    st.header("Client Summary")

    st.subheader("YEAR TO DATE (Ordered Product Sales)")
    ytd_rows = []
    for c in CLIENTS:
        cur, prev, pct_from_report, _ = get_ytd_for_client(c)
        diff, fallback_pct = diff_pct(cur, prev)
        ytd_rows.append({
            "Client": c,
            "This year so far": fmt_currency(cur),
            "Last year": fmt_currency(prev),
            "Difference": fmt_diff(diff),
            "Difference %": pct_from_report if pct_from_report else fallback_pct,
        })
    ytd_df = pd.DataFrame(ytd_rows)
    st.dataframe(style_percent_columns(ytd_df, ["Difference %"]), use_container_width=True)

    st.divider()

    st.subheader("MONTH TO DATE (Ordered Product Sales)")
    mtd_rows = []
    for c in CLIENTS:
        cur, prev, pct_from_report, _ = get_mtd_for_client(c)
        diff, fallback_pct = diff_pct(cur, prev)
        mtd_rows.append({
            "Client": c,
            "This month so far": fmt_currency(cur),
            "Last month": fmt_currency(prev),
            "Difference": fmt_diff(diff),
            "Difference %": pct_from_report if pct_from_report else fallback_pct,
        })
    mtd_df = pd.DataFrame(mtd_rows)
    st.dataframe(style_percent_columns(mtd_df, ["Difference %"]), use_container_width=True)

    st.divider()

    st.subheader("WEEKLY BREAKDOWN (Last 6 Weeks)")
    for c in CLIENTS:
        st.markdown(f"### {c}")
        wtd_df, _ = get_wtd_last_6_weeks_for_client(c, n_weeks=6)
        if wtd_df.empty:
            st.info("No Week report found yet.")
        else:
            st.dataframe(style_percent_columns(wtd_df, ["Year over Year"]), use_container_width=True)
        st.write("")


def render_client_page(client: str):
    st.header(client)

    c1, c2 = st.columns(2)
    with c1:
        st.subheader("YTD (Ordered Product Sales)")
        cur, prev, pct_from_report, _ = get_ytd_for_client(client)
        diff, fallback_pct = diff_pct(cur, prev)
        st.metric("This year so far", fmt_currency(cur), fmt_diff(diff))
        st.caption(f"Last year: {fmt_currency(prev)} | Diff %: {(pct_from_report if pct_from_report else fallback_pct)}")

    with c2:
        st.subheader("MTD (Ordered Product Sales)")
        cur, prev, pct_from_report, _ = get_mtd_for_client(client)
        diff, fallback_pct = diff_pct(cur, prev)
        st.metric("This month so far", fmt_currency(cur), fmt_diff(diff))
        st.caption(f"Last month: {fmt_currency(prev)} | Diff %: {(pct_from_report if pct_from_report else fallback_pct)}")

    st.divider()
    st.subheader("WTD (Last 6 Weeks)")
    wtd_df, _ = get_wtd_last_6_weeks_for_client(client, n_weeks=6)
    if wtd_df.empty:
        st.info("No Week report found yet.")
    else:
        st.dataframe(style_percent_columns(wtd_df, ["Year over Year"]), use_container_width=True)

    st.divider()
    st.subheader("DETAIL SALES & TRAFFIC (Per ASIN)")
    detail_df, _ = get_detail_sales_traffic_weekly_for_client(client, n_weeks=6)
    if detail_df.empty:
        st.info("No Detail Sales & Traffic")
    else:
        asins = detail_df["ASIN"].dropna().unique().tolist()
        for asin in asins:
            st.markdown(f"#### {asin}")
            asin_tbl = detail_df[detail_df["ASIN"] == asin].drop(columns=["ASIN"]).reset_index(drop=True)
            st.dataframe(asin_tbl, use_container_width=True, hide_index=True)


def render_listing_metrics_tracker():
    st.header("Listing Metrics Tracker")
    st.caption("Compares last 7 days vs previous 7 days per ASIN (static rule).")

    summary_df, detail_df = compute_listing_metric_triggers_all_clients()
    st.subheader("Summary (by Client)")
    st.dataframe(summary_df, use_container_width=True)

    st.subheader("Triggered ASINs (All Clients)")
    if detail_df.empty:
        st.info("No triggers found (or missing data in Detail Sales & Traffic).")
    else:
        st.dataframe(detail_df, use_container_width=True)


def render_seller_health():
    st.header("Seller Health")

    client = st.selectbox("Client", CLIENTS, index=0)
    hist = get_seller_health_history_for_client(client)

    if hist.empty:
        st.info("No seller health data found for this client (check folder name contains 'seller' and 'health').")
        return

    st.dataframe(hist, use_container_width=True)
    st.caption("Reads weekly Seller Health tables like your screenshot (Client | Week of | Account Health | Suppressed listings | Seller Feedback).")


# =========================
# Render selected page
# =========================
if page == "Client Summary":
    render_client_summary()
elif page == "Client Pages":
    render_client_page(selected_client)
elif page == "Listing Metrics Tracker":
    render_listing_metrics_tracker()
else:
    render_seller_health()
